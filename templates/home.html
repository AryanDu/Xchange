<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XCHANGE ‚Äî Discover People</title>

  <!-- Tailwind CDN (quick) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Axios for API calls -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

  <!-- GSAP for animations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <!-- Vanilla-tilt for 3D tilt effect -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-tilt/1.7.2/vanilla-tilt.min.js"></script>

  <!-- Heroicons (optional small icons) -->
  <script src="https://unpkg.com/feather-icons"></script>
<!-- ===== REPLACE YOUR OLD GLOBAL RULE WITH THIS SAFE BLOCK ===== -->
<style>
  /* 1) Remove blur/backdrop filters site-wide (but do NOT force opacity) */
  * {
    filter: none !important;
    -webkit-filter: none !important;
    backdrop-filter: none !important;
    -webkit-backdrop-filter: none !important;
    /* NOTE: opacity intentionally NOT touched here */
  }

  /* 2) Restore natural appearance for card-like elements:
     If your cards use a different class, add that classname here.
     This targets common card class name patterns safely. */
  [class*="card"], [class*="Card"], .user-card, .profile-card, .product-card, .post-card {
    opacity: unset !important;        /* remove any forced opacity */
    background-color: rgba(255,255,255,0.98) !important; /* optional: keep card background slightly solid */
    box-shadow: 0 6px 18px rgba(0,0,0,0.12) !important;  /* optional: restore depth */
    border-radius: 8px !important; /* optional */
  }

  /* 3) If some specific element still looks washed, add its selector here:
     Example:
     .my-special-card { opacity: unset !important; }
  */
</style>



  <style>
    /* Custom theme colors */
    :root{
      --accent1: #2bb673;
      --accent2: #17a85a;
      --bg-start: #ffffff;
      --bg-end: #eafaf0;
      --muted: #6b7b6b;
      --card-shadow: 0 18px 40px rgba(16, 90, 45, 0.06);
    }

    /* page background - CLEAN WHITE */
    body{
      background: linear-gradient(180deg, #ffffff, #f5fdf9);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
    }

    /* Animated gradient background */
    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    /* Enhanced glass effect WITHOUT blur on cards */
    .glass {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(250, 255, 253, 0.92));
      border-radius: 18px;
      box-shadow: 
        0 8px 32px rgba(43, 182, 115, 0.08),
        inset 0 1px 1px rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(20, 60, 40, 0.08);
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    .glass:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(250, 255, 253, 0.96));
      box-shadow: 
        0 12px 48px rgba(43, 182, 115, 0.12),
        inset 0 1px 1px rgba(255, 255, 255, 0.9);
      transform: translateY(-2px);
    }

    /* Premium 3D card effect */
    .card-3d{
      transform-style: preserve-3d;
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
      position: relative;
      overflow: hidden;
      background: #ffffff !important;
    }

    .card-3d::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s cubic-bezier(0.2, 0.9, 0.3, 1);
      z-index: 10;
      pointer-events: none;
    }

    .card-3d:hover::before {
      left: 100%;
    }

    .card-3d:hover{ 
      transform: translateY(-12px) scale(1.008) rotateX(2deg);
      box-shadow: 
        0 35px 70px rgba(43, 182, 115, 0.15),
        0 0 40px rgba(43, 182, 115, 0.1);
    }

    /* Gradient text effect */
    .gradient-text {
      background: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Animated gradient button */
    .btn-gradient {
      background: linear-gradient(135deg, var(--accent1) 0%, var(--accent2) 100%);
      background-size: 200% 200%;
      animation: gradientFlow 3s ease infinite;
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    @keyframes gradientFlow {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }

    .btn-gradient:hover {
      transform: translateY(-2px);
      box-shadow: 0 15px 35px rgba(43, 182, 115, 0.3);
    }

    .btn-gradient:active {
      transform: translateY(0px);
    }

    /* skill chip with enhanced styling */
    .chip{
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(250, 255, 250, 0.95));
      border: 1px solid rgba(43, 182, 115, 0.15);
      padding: 7px 12px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      color: var(--accent1);
      transition: all 0.2s cubic-bezier(0.2, 0.9, 0.3, 1);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(43, 182, 115, 0.05);
    }

    .chip:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(43, 182, 115, 0.1);
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.1), rgba(23, 168, 90, 0.05));
    }

    .chip.active {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: white;
      box-shadow: 0 4px 12px rgba(43, 182, 115, 0.2);
    }

    /* chat popup with enhanced styling */
    #chatPopup {
      width: 360px;
      max-width: calc(100% - 24px);
      bottom: 26px;
      right: 26px;
      position: fixed;
      z-index: 80;
      display: none;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 
        0 25px 50px rgba(16, 90, 45, 0.15),
        0 0 40px rgba(43, 182, 115, 0.1);
      background: #ffffff;
      border: 1px solid rgba(20, 60, 40, 0.08);
      animation: slideUp 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #chatHeader{
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: white;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(43, 182, 115, 0.2);
    }

    #chatBody{
      padding: 14px;
      max-height: 300px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #ffffff;
    }

    #chatComposer{
      display: flex;
      gap: 8px;
      padding: 12px;
      border-top: 1px solid rgba(0, 0, 0, 0.04);
      background: #ffffff;
    }

    #chatInput {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(43, 182, 115, 0.15);
      font-size: 13px;
      transition: all 0.2s;
    }

    #chatInput:focus {
      outline: none;
      border-color: var(--accent1);
      box-shadow: 0 0 0 3px rgba(43, 182, 115, 0.1);
    }

    /* smooth scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(43, 182, 115, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(43, 182, 115, 0.4);
    }

    /* Enhanced header */
    header {
      background: #ffffff;
      border-bottom: 1px solid rgba(43, 182, 115, 0.08);
      box-shadow: 0 2px 8px rgba(43, 182, 115, 0.04);
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    /* smooth page transitions */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    main {
      animation: fadeIn 0.5s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    /* button styling improvements */
    button {
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    .connectBtn,
    .chatBtn {
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);
      cursor: pointer;
    }

    .connectBtn {
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.1), rgba(23, 168, 90, 0.05));
      border: 2px solid var(--accent1);
      color: var(--accent1);
    }

    .connectBtn:hover {
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.15), rgba(23, 168, 90, 0.1));
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(43, 182, 115, 0.15);
    }

    .chatBtn {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: white;
      box-shadow: 0 4px 12px rgba(43, 182, 115, 0.2);
    }

    .chatBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(43, 182, 115, 0.3);
    }

    /* Mobile responsiveness */
    @media (max-width: 900px){
      #leftCol {
        display: none;
      }
    }

    /* Enhanced badge animation */
    @keyframes pulse-glow {
      0%, 100% {
        box-shadow: 0 0 20px rgba(43, 182, 115, 0.5);
      }
      50% {
        box-shadow: 0 0 30px rgba(43, 182, 115, 0.8);
      }
    }

    /* Loading skeleton animation */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }
      100% {
        background-position: 1000px 0;
      }
    }

    .animate-pulse {
      animation: shimmer 2s infinite;
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.05) 0%,
        rgba(43, 182, 115, 0.1) 50%,
        rgba(255, 255, 255, 0.05) 100%);
      background-size: 1000px 100%;
    }

    /* Text shadow for premium feel */
    h1,
    h2 {
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    /* Logo placeholder styling */
    .logo-placeholder {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.1), rgba(23, 168, 90, 0.05));
      border: 2px dashed rgba(43, 182, 115, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--accent1);
      cursor: pointer;
      transition: all 0.2s;
    }

    .logo-placeholder:hover {
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.15), rgba(23, 168, 90, 0.1));
      border-color: var(--accent1);
    }

    /* User profile badge styling */
    .user-badge {
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.15), rgba(23, 168, 90, 0.08));
      border: 1px solid rgba(43, 182, 115, 0.2);
      padding: 8px 14px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 13px;
      color: var(--accent1);
      box-shadow: 0 2px 8px rgba(43, 182, 115, 0.08);
    }

    /* Header nav button styling */
    .nav-btn {
      font-weight: 600;
      font-size: 13px;
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 10px;
      transition: all 0.2s cubic-bezier(0.2, 0.9, 0.3, 1);
    }

    .nav-btn:hover {
      color: var(--accent1);
      background: rgba(43, 182, 115, 0.08);
    }

    .nav-btn.active {
      color: var(--accent1);
      background: linear-gradient(135deg, rgba(43, 182, 115, 0.1), rgba(23, 168, 90, 0.05));
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top bar -->
  <header class="w-full py-4 px-6 flex items-center justify-between sticky top-0 z-50">
    <div class="flex items-center gap-3">
      <!-- Logo placeholder for image -->
      <a href="#" class="logo-placeholder" title="Click to add logo">üì∑</a>
      <div>
        <div class="text-xl font-semibold gradient-text">XCHANGE</div>
        <div class="text-sm text-[var(--muted)]">Learn together ‚Ä¢ Connect faster</div>
      </div>
    </div>

    <!-- NAV + RIGHT ACTIONS -->
    <div class="flex items-center gap-2 w-full justify-end">
      <div class="flex items-center gap-2 mr-auto">
        <button id="btnHome" class="nav-btn active" title="Go to Home">Home</button>
        <button class="nav-btn" title="About our platform">About Us</button>
        <button class="nav-btn" title="Get help">Help</button>
        <button class="nav-btn" title="Sign in / Sign up">Signup</button>
      </div>

      <div class="h-6 w-px bg-[var(--accent1)] bg-opacity-20 mx-3"></div>

      <!-- Right-most stacked area: profile, friends, notifications, logout -->
      <div class="flex items-center gap-3">
        <div class="user-badge" id="btnProfile" title="View your profile">üë§ Profile</div>

        <!-- Friends button with count -->
        <button id="btnFriends" class="flex items-center gap-2 px-3 py-2 rounded-md text-sm font-semibold">
          <span class="hidden md:inline">My Friends</span>
          <span id="friendsCount" class="ml-1 text-xs text-[var(--muted)]">0</span>
        </button>

        <!-- Notifications bell with badge -->
        <div class="relative">
          <button id="notifBtn" class="px-3 py-2 rounded-md text-sm font-semibold relative" title="Notifications">
            üîî
            <span id="notifBadge" class="hidden absolute -right-1 -top-1 bg-red-500 text-white rounded-full px-1 text-xs">0</span>
          </button>
        </div>

        <button id="btnLogout" class="nav-btn" style="color: #ef4444;" title="Logout">Logout</button>
      </div>
    </div>
  </header>

  <!-- Main layout -->
  <main class="max-w-7xl mx-auto px-6 pb-20 bg-white">
    <div class="grid grid-cols-12 gap-8">
      <!-- Left: filters + search -->
      <aside id="leftCol" class="col-span-3">
        <div class="sticky top-24">
          <div class="glass p-5 mb-5 rounded-lg">
            <div class="text-sm font-semibold mb-3 gradient-text">üîç Search Skills</div>
            <div class="flex gap-2">
              <input id="searchInput" type="search" placeholder="Search by skill e.g. Python" class="w-full px-4 py-2 rounded-lg border border-transparent focus:outline-none focus:ring-2 focus:ring-[var(--accent1)] bg-white transition-all" />
              <button id="btnSearch" class="px-4 py-2 rounded-lg btn-gradient text-white font-semibold">Go</button>
            </div>
          </div>

          <div class="glass p-5 mb-5 rounded-lg">
            <div class="text-sm font-semibold mb-3 gradient-text">‚öôÔ∏è Filters</div>

            <label class="block mb-3 text-sm font-medium">Age Range</label>
            <select id="ageFilter" class="w-full px-4 py-2 rounded-lg border border-[var(--accent1)] border-opacity-15 focus:outline-none focus:ring-2 focus:ring-[var(--accent1)] bg-white transition-all">
              <option value="">Any age</option>
              <option value="lt18">&lt; 18</option>
              <option value="18-25">18 - 25</option>
              <option value="25-35">25 - 35</option>
              <option value="35+">35+</option>
            </select>

            <div class="mt-4">
              <div class="text-sm font-semibold mb-3 gradient-text">Skills (Select)</div>
              <div id="skillsList" class="grid grid-cols-2 gap-2 text-sm">
                <!-- dynamically populated -->
              </div>
            </div>

            <div class="mt-4">
              <div class="text-sm font-semibold mb-3 gradient-text">Languages</div>
              <div class="flex gap-2 flex-wrap text-sm" id="languagesList">
                <button class="chip lang-btn" data-filter-type="lang" data-filter-value="English">English</button>
                <button class="chip lang-btn" data-filter-type="lang" data-filter-value="Hindi">Hindi</button>
                <button class="chip lang-btn" data-filter-type="lang" data-filter-value="Spanish">Spanish</button>
              </div>
            </div>

            <div class="mt-5 flex gap-2">
              <button id="btnApply" class="flex-1 px-4 py-2 rounded-lg btn-gradient text-white font-semibold">Apply</button>
              <button id="btnClear" class="flex-1 px-4 py-2 rounded-lg border-2 border-[var(--accent1)] text-[var(--accent1)] font-semibold hover:bg-[var(--accent1)] hover:text-white transition-all">Clear</button>
            </div>
          </div>

          <div class="glass p-5 rounded-lg">
            <div class="font-semibold mb-2 gradient-text">üí° Suggestions</div>
            <div class="text-sm text-[var(--muted)]">People you might like ‚Äî updated based on filters and randomness.</div>
          </div>
        </div>
      </aside>

      <!-- Center: feed -->
      <section id="feedCol" class="col-span-9">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="text-3xl font-semibold gradient-text">Discover People</h2>
            <p class="text-[var(--muted)] text-sm mt-1">Meet amazing people with shared interests</p>
          </div>
          <div class="text-sm font-semibold text-[var(--accent1)]" id="resultsCount">‚Äî</div>
        </div>

        <div id="feedGrid" class="space-y-5 bg-white">
          <!-- cards inserted here - ONE PER LINE NOW! -->
        </div>

        <div id="emptyState" class="hidden text-center text-[var(--muted)] py-16">
          <div class="text-5xl mb-4">üîç</div>
          <div class="text-lg font-semibold mb-2">No people found</div>
          <p class="text-sm">Try clearing filters or searching with different keywords</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Notifications slide-over (inserted) -->
  <div id="notifPanel" class="fixed right-0 top-0 h-full w-96 bg-white shadow-xl transform translate-x-full transition-transform z-50 overflow-auto">
    <div class="p-4 border-b flex items-center justify-between">
      <div class="font-semibold">Notifications</div>
      <div><button id="notifClose" class="text-sm text-[var(--muted)]">Close</button></div>
    </div>
    <div id="notifList" class="p-4 space-y-3">
      <!-- items injected here -->
    </div>
    <div class="p-4 border-t text-sm text-[var(--muted)]">You will see friend requests & activity here.</div>
  </div>

  <!-- Chat popup (prototype) -->
  <div id="chatPopup" class="rounded-xl">
    <div id="chatHeader">
      <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center; font-weight: 700; color: white;">XS</div>
      <div id="chatTitle" style="font-weight: 700; flex: 1;">Chat</div>
      <div style="cursor: pointer; font-size: 20px; line-height: 1; color: white; opacity: 0.7; transition: opacity 0.2s;" id="chatClose">‚úï</div>
    </div>
    <div id="chatBody"></div>
    <div id="chatComposer">
      <input id="chatInput" class="flex-1 px-3 py-2 rounded-lg border border-[var(--accent1)] border-opacity-15" placeholder="Write a message..." />
      <button id="chatSend" class="px-4 py-2 rounded-lg btn-gradient text-white font-semibold">Send</button>
    </div>
  </div>

<script>
/* ===========================
   XCHANGE home page script
   This script replaces the previous JS block. It is defensive,
   integrates friends + notifications, and keeps the rest of the page intact.
   =========================== */

/* ---------- Config ---------- */
const API_BASE = 'http://127.0.0.1:8000';
axios.defaults.baseURL = API_BASE;

/* ---------- Helpers ---------- */
function showToast(msg, ttl = 2200) {
  try {
    const el = document.createElement('div');
    el.textContent = msg;
    el.style.position = 'fixed';
    el.style.right = '18px';
    el.style.bottom = '18px';
    el.style.padding = '10px 14px';
    el.style.borderRadius = '10px';
    el.style.background = 'white';
    el.style.boxShadow = '0 10px 30px rgba(10,40,20,0.08)';
    el.style.zIndex = 9999;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), ttl);
  } catch (e) { console.log('toast', e); }
}

function escapeHtml(txt) {
  if (!txt) return '';
  return String(txt).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function authHeaders() {
  const token = localStorage.getItem('access_token');
  return { headers: { Authorization: 'Bearer ' + (token || '') } };
}

/* ---------- DOM refs (graceful selection) ---------- */
const feedGrid = document.getElementById('feedGrid');
const resultsCount = document.getElementById('resultsCount');
const searchInput = document.getElementById('searchInput');
const btnSearch = document.getElementById('btnSearch');
const btnApply = document.getElementById('btnApply');
const btnClear = document.getElementById('btnClear');
const ageFilter = document.getElementById('ageFilter');
const skillsListEl = document.getElementById('skillsList');
const emptyState = document.getElementById('emptyState');
const notifBtn = document.getElementById('notifBtn');
const notifPanel = document.getElementById('notifPanel');
const notifClose = document.getElementById('notifClose');
const notifBadge = document.getElementById('notifBadge');
const notifList = document.getElementById('notifList');
const btnFriends = document.getElementById('btnFriends');
const friendsCountEl = document.getElementById('friendsCount');
const chatPopup = document.getElementById('chatPopup');
const chatBody = document.getElementById('chatBody');
const chatTitle = document.getElementById('chatTitle');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const chatClose = document.getElementById('chatClose');

let allUsers = [];
let currentFilters = { search: '', age: '', skills: [], lang: '' };
let activeChatUser = null;

/* ---------- Avatar helper ---------- */
function avatarLetters(user) {
  const name = (user.full_name || user.username || 'XS').trim();
  return name.split(' ').map(x => x[0]).slice(0,2).join('').toUpperCase();
}

/* ---------- makeCard (returns element) ---------- */
function makeCard(user) {
  const div = document.createElement('div');
  div.className = 'glass p-4 rounded-xl card-3d';
  div.setAttribute('data-tilt', '');
  div.setAttribute('data-tilt-max', '8');
  div.setAttribute('data-tilt-speed', '600');

  // Avatar HTML with fallback
  const avatarHtml = user.avatar_url ? `
    <div style="display:inline-block;position:relative">
      <img loading="lazy" alt="${escapeHtml(user.full_name || user.username)} avatar"
           src="${escapeHtml(user.avatar_url)}"
           onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
           class="w-14 h-14 rounded-lg object-cover" />
      <div style="display:none" class="w-14 h-14 rounded-lg flex items-center justify-center font-bold text-xl bg-gradient-to-br from-[var(--accent1)] to-[var(--accent2)] text-white">
        ${avatarLetters(user)}
      </div>
    </div>
  ` : `<div class="w-14 h-14 rounded-lg flex-shrink-0 bg-gradient-to-br from-[var(--accent1)] to-[var(--accent2)] text-white flex items-center justify-center font-bold text-xl">${avatarLetters(user)}</div>`;

  div.innerHTML = `
    <div class="flex items-start gap-3">
      ${avatarHtml}
      <div class="flex-1">
        <div class="flex items-center justify-between gap-2">
          <div>
            <div class="font-semibold">${escapeHtml(user.full_name || user.username)}</div>
            <div class="text-xs text-[var(--muted)]">${escapeHtml((user.languages||[]).join(', '))}</div>
          </div>
          <div class="text-xs text-[var(--muted)]">${user.age ? user.age + 'y' : ''}</div>
        </div>

        <p class="text-sm text-[var(--muted)] mt-3 line-clamp-4">${escapeHtml(user.bio || '')}</p>

        <div class="mt-3 flex gap-2 flex-wrap">
          ${(user.skills || []).slice(0,5).map(s => `<span class="chip">${escapeHtml(s)}</span>`).join('')}
        </div>

        <div class="mt-4 flex gap-2">
          <button class="connectBtn px-3 py-2 rounded-lg border font-semibold">Connect</button>
          <button class="chatBtn px-3 py-2 rounded-lg bg-[var(--accent1)] text-white font-semibold">Chat</button>
        </div>
      </div>
    </div>
  `;
  return div;
}

/* ---------- fetchProfile & fetchFeed ---------- */
async function fetchProfile() {
  try {
    const res = await axios.get('/api/me/', authHeaders());
    return res.data;
  } catch (e) {
    console.error('fetchProfile error', e);
    throw e;
  }
}

async function fetchFeed(params = {}) {
  try {
    const q = new URLSearchParams();
    if (params.search) q.append('search', params.search);
    if (params.age) q.append('age', params.age);
    if (params.lang) q.append('lang', params.lang);
    if (params.skills && params.skills.length) q.append('skills', params.skills.join(','));
    const url = '/api/users/?' + q.toString();
    const res = await axios.get(url, authHeaders());
    return res.data;
  } catch (err) {
    console.error('fetchFeed error', err);
    return [];
  }
}

/* ---------- populateSkills ---------- */
function populateSkills(users) {
  if (!skillsListEl) return;
  const set = new Set();
  users.forEach(u => (u.skills || []).forEach(s => set.add(s)));
  const arr = Array.from(set).sort();
  skillsListEl.innerHTML = arr.slice(0,10).map(s => `<button class="chip skill-btn" data-skill="${escapeHtml(s)}">${escapeHtml(s)}</button>`).join('');
  skillsListEl.querySelectorAll('.skill-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const skill = btn.dataset.skill;
      if (currentFilters.skills.includes(skill)) {
        currentFilters.skills = currentFilters.skills.filter(x => x !== skill);
        btn.classList.remove('ring-2','ring-[var(--accent1)]');
      } else {
        currentFilters.skills.push(skill);
        btn.classList.add('ring-2','ring-[var(--accent1)]');
      }
    });
  });
}

/* ---------- sendFriendRequest & wireCardActions ---------- */
async function sendFriendRequest(user) {
  try {
    const res = await axios.post('/api/friends/request/', { to_user: user.id }, authHeaders());
    showToast('Connection request sent');
    await loadNotifications();
    await refreshFriendsCount();
  } catch (e) {
    console.error('sendFriendRequest', e);
    const msg = e?.response?.data?.detail || 'Request failed';
    showToast(msg);
  }
}

function wireCardActions(cardEl, user) {
  const connectBtn = cardEl.querySelector('.connectBtn');
  const chatBtn = cardEl.querySelector('.chatBtn');

  if (connectBtn) {
    connectBtn.onclick = null;
    connectBtn.addEventListener('click', () => {
      connectBtn.textContent = 'Pending';
      sendFriendRequest(user);
    });
  }
  if (chatBtn) {
    chatBtn.onclick = null;
    chatBtn.addEventListener('click', () => openChat(user));
  }
}

/* ---------- loadAndRender ---------- */
async function loadAndRender() {
  feedGrid.innerHTML = '';
  for (let i = 0; i < 6; i++) {
    const s = document.createElement('div');
    s.className = 'p-4 rounded-xl glass animate-pulse';
    s.style.height = '180px';
    feedGrid.appendChild(s);
  }

  const data = await fetchFeed({ search: currentFilters.search, age: currentFilters.age, skills: currentFilters.skills, lang: currentFilters.lang });
  allUsers = Array.isArray(data) ? data : (data.results || []);
  feedGrid.innerHTML = '';

  if (allUsers.length === 0) {
    if (emptyState) emptyState.classList.remove('hidden');
    if (resultsCount) resultsCount.textContent = '0 results';
    return;
  } else {
    if (emptyState) emptyState.classList.add('hidden');
    if (resultsCount) resultsCount.textContent = `${allUsers.length} people`;
  }

  allUsers.forEach((u, idx) => {
    const c = makeCard(u);
    feedGrid.appendChild(c);
    wireCardActions(c, u);
  });

  try {
    if (window.VanillaTilt) {
      VanillaTilt.init(document.querySelectorAll('[data-tilt]'), { max: 8, speed: 600, glare: true, "max-glare": 0.08 });
    }
  } catch (e) {}

  try {
    if (window.gsap) {
      gsap.from('.glass.card-3d', { y: 20, opacity: 0, stagger: 0.06, duration: 0.6, ease: "power3.out" });
    }
  } catch (e) {}
}

/* ---------- Friends count & Notifications ---------- */
async function refreshFriendsCount() {
  try {
    const res = await axios.get('/api/friends/', authHeaders());
    const friends = res.data || [];
    if (friendsCountEl) friendsCountEl.textContent = friends.length;
  } catch (e) {
    console.warn('refreshFriendsCount', e);
  }
}

async function loadNotifications() {
  if (!notifList) return;
  try {
    const res = await axios.get('/api/notifications/', authHeaders());
    const list = res.data || [];
    const unread = list.filter(n => !n.is_read).length;
    if (notifBadge) {
      if (unread > 0) {
        notifBadge.classList.remove('hidden');
        notifBadge.textContent = unread;
      } else {
        notifBadge.classList.add('hidden');
      }
    }
    notifList.innerHTML = '';
    list.forEach(n => {
      const el = document.createElement('div');
      el.className = 'p-3 rounded-md border flex items-start gap-3';
      const actorText = n.actor ? (n.actor.full_name || 'User') : '';
      el.innerHTML = `
        <div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-sm font-bold">${escapeHtml(actorText.split(' ').map(s=>s[0]).slice(0,2).join(''))}</div>
        <div class="flex-1">
          <div class="text-sm font-semibold">${escapeHtml(n.text)}</div>
          <div class="text-xs text-[var(--muted)] mt-1">${new Date(n.created_at).toLocaleString()}</div>
        </div>
        <div class="flex flex-col gap-2 items-end">
          ${n.type === 'friend_request' && n.data && n.data.request_id ? `<button class="acceptBtn chip" data-id="${n.data.request_id}">Accept</button><button class="rejectBtn chip" data-id="${n.data.request_id}">Reject</button>` : `<button class="viewBtn chip" data-id="${n.id}">View</button>`}
        </div>
      `;
      notifList.appendChild(el);
    });

    notifList.querySelectorAll('.acceptBtn').forEach(b => b.addEventListener('click', async (ev) => {
      const id = ev.currentTarget.dataset.id;
      try {
        await axios.post(`/api/friends/request/${id}/accept/`, {}, authHeaders());
        showToast('Accepted');
        await loadNotifications(); await refreshFriendsCount(); await loadAndRender();
      } catch (e) { showToast('Accept failed'); }
    }));
    notifList.querySelectorAll('.rejectBtn').forEach(b => b.addEventListener('click', async (ev) => {
      const id = ev.currentTarget.dataset.id;
      try {
        await axios.post(`/api/friends/request/${id}/reject/`, {}, authHeaders());
        showToast('Rejected');
        await loadNotifications(); await loadAndRender();
      } catch (e) { showToast('Reject failed'); }
    }));
    notifList.querySelectorAll('.viewBtn').forEach(b => b.addEventListener('click', (ev) => {
      showToast('View not implemented');
    }));
  } catch (e) {
    console.error('loadNotifications', e);
  }
}

/* ---------- Chat popup (basic) ---------- */
function openChat(user) {
  activeChatUser = user;
  if (chatPopup) chatPopup.style.display = 'block';
  if (chatTitle) chatTitle.textContent = `Chat with ${user.full_name || user.username}`;
  if (chatBody) chatBody.innerHTML = `<div class="text-sm text-[var(--muted)]">Loading messages...</div>`;
  axios.get(`/api/chat/${user.id}/`, authHeaders()).then(res => {
    renderMessages(res.data || []);
  }).catch(e => {
    chatBody.innerHTML = `<div class="text-sm text-[var(--muted)]">No messages yet. Say hi!</div>`;
  });
}

function renderMessages(list) {
  if (!chatBody) return;
  chatBody.innerHTML = '';
  list.forEach(m => {
    const el = document.createElement('div');
    el.className = 'mb-2';
    el.innerHTML = `<div class="text-xs text-[var(--muted)]">${escapeHtml(m.from_name || m.from || '')}</div><div class="p-2 rounded-lg bg-white border text-sm">${escapeHtml(m.text || '')}</div>`;
    chatBody.appendChild(el);
  });
  chatBody.scrollTop = chatBody.scrollHeight;
}

if (chatSend) {
  chatSend.addEventListener('click', async () => {
    if (!activeChatUser) return;
    const text = (chatInput.value || '').trim();
    if (!text) return;
    const bubble = document.createElement('div'); bubble.className = 'p-2 mb-2 bg-[var(--accent1)] text-white rounded-lg text-sm self-end'; bubble.textContent = text;
    if (chatBody) chatBody.appendChild(bubble);
    if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
    if (chatInput) chatInput.value = '';
    try {
      await axios.post(`/api/chat/${activeChatUser.id}/send/`, { message: text }, authHeaders());
    } catch (e) { showToast('Message failed'); }
  });
}
if (chatClose) chatClose.addEventListener('click', ()=> { if (chatPopup) chatPopup.style.display = 'none'; });

/* ---------- Top bar wiring ---------- */
if (notifBtn) {
  notifBtn.addEventListener('click', () => {
    const panel = document.getElementById('notifPanel');
    if(!panel) return;
    if (panel.style.transform === 'translateX(0%)') {
      panel.style.transform = 'translateX(100%)';
    } else {
      panel.style.transform = 'translateX(0%)';
      loadNotifications();
    }
  });
}
if (notifClose) notifClose.addEventListener('click', ()=> { if (notifPanel) notifPanel.style.transform = 'translateX(100%)'; });
if (btnFriends) btnFriends.addEventListener('click', ()=> { window.location.href = '/friends/'; });

if (btnSearch) btnSearch.addEventListener('click', ()=> { currentFilters.search = (searchInput.value || '').trim(); loadAndRender(); });
if (searchInput && searchInput.addEventListener) searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { currentFilters.search = (searchInput.value || '').trim(); loadAndRender(); }});
if (btnApply) btnApply.addEventListener('click', ()=> { currentFilters.age = ageFilter.value; loadAndRender(); });
if (btnClear) btnClear.addEventListener('click', ()=> { currentFilters = { search:'', age:'', skills:[], lang:'' }; if (ageFilter) ageFilter.value=''; if (searchInput) searchInput.value=''; loadAndRender(); });

document.getElementById('btnLogout').addEventListener('click', ()=> {
  localStorage.removeItem('access_token'); localStorage.removeItem('refresh_token'); window.location.href = '/login/';
});

document.getElementById('btnProfile').addEventListener('click', ()=> {
  window.location.href = '/profile/'; // implement profile page
});

/* ---------- init (no flash) ---------- */
async function init() {
  const access = localStorage.getItem('access_token');
  if (!access) { window.location.href = '/login/'; return; }

  try {
    const meRes = await axios.get('/api/me/', authHeaders());
    const me = meRes.data;
    const btnProfile = document.getElementById('btnProfile');
    if (btnProfile) btnProfile.textContent = (me.full_name || me.username) ? 'üë§ ' + (me.full_name || me.username) : 'üë§ Profile';
  } catch (e) {
    console.error('token verify fail', e);
    window.location.href = '/login/';
    return;
  }

  try {
    const seed = await fetchFeed({});
    allUsers = Array.isArray(seed) ? seed : (seed.results || []);
    populateSkills(allUsers);
    await loadAndRender();
    await refreshFriendsCount();
    await loadNotifications();
    setInterval(loadNotifications, 20000);
  } catch (e) {
    console.error('init load fail', e);
  }
}

/* run init on load */
init();
</script>

</body>
</html>
